{"ast":null,"code":"import _asyncToGenerator from \"C:/Users/BongumusaN/TestingApp/client/node_modules/@babel/runtime/helpers/esm/asyncToGenerator.js\";\nimport { environment } from 'src/environments/environment';\nimport { getPaginatedResult, getPaginationHeaders } from './paginationHelper';\nimport { HubConnectionBuilder } from '@microsoft/signalr';\nimport { BehaviorSubject, take } from 'rxjs';\nimport * as i0 from \"@angular/core\";\nimport * as i1 from \"@angular/common/http\";\nimport * as i2 from \"./busy.service\";\nexport class MessageService {\n  constructor(http, busyService) {\n    this.http = http;\n    this.busyService = busyService;\n    this.baseUrl = environment.apiUrl;\n    this.hubUrl = environment.hubUrl;\n    this.messageThreadSouce = new BehaviorSubject([]);\n    this.messageThread$ = this.messageThreadSouce.asObservable();\n  }\n  createHubConnection(user, otherUsername) {\n    this.busyService.busy();\n    this.hubConnection = new HubConnectionBuilder().withUrl(this.hubUrl + 'message?user=' + otherUsername, {\n      accessTokenFactory: () => user.token\n    }).withAutomaticReconnect().build();\n    this.hubConnection.start().catch(error => console.log(error)).finally(() => this.busyService.idle());\n    this.hubConnection.on('ReceiveMessageThread', messages => {\n      this.messageThreadSouce.next(messages);\n    });\n    this.hubConnection.on('NewMessage', message => {\n      this.messageThread$.pipe(take(1)).subscribe({\n        next: messages => {\n          this.messageThreadSouce.next([...messages, message]);\n        }\n      });\n    });\n    this.hubConnection.on('UpdatedGroup', group => {\n      if (group.connections.some(x => x.username === otherUsername)) {\n        this.messageThread$.pipe(take(1)).subscribe({\n          next: messages => {\n            messages.forEach(message => {\n              if (!message.dateRead) {\n                message.dateRead = new Date(Date.now());\n              }\n            });\n            this.messageThreadSouce.next([...messages]);\n          }\n        });\n      }\n    });\n  }\n  stopHubConnection() {\n    if (this.hubConnection) {\n      this.messageThreadSouce.next([]);\n      this.hubConnection?.stop();\n    }\n  }\n  getMessages(pageNumber, pageSize, container) {\n    let params = getPaginationHeaders(pageNumber, pageSize);\n    params = params.append('Container', container);\n    return getPaginatedResult(this.baseUrl + 'messages', params, this.http);\n  }\n  getMessageThread(username) {\n    return this.http.get(this.baseUrl + 'messages/thread/' + username);\n  }\n  sendMessage(username, content) {\n    var _this = this;\n    return _asyncToGenerator(function* () {\n      return _this.hubConnection?.invoke('SendMessage', {\n        recipientUsername: username,\n        content\n      }).catch(error => console.log(error));\n    })();\n  }\n  deleteMessage(id) {\n    return this.http.delete(this.baseUrl + 'messages/' + id);\n  }\n  static #_ = this.ɵfac = function MessageService_Factory(t) {\n    return new (t || MessageService)(i0.ɵɵinject(i1.HttpClient), i0.ɵɵinject(i2.BusyService));\n  };\n  static #_2 = this.ɵprov = /*@__PURE__*/i0.ɵɵdefineInjectable({\n    token: MessageService,\n    factory: MessageService.ɵfac,\n    providedIn: 'root'\n  });\n}","map":{"version":3,"names":["environment","getPaginatedResult","getPaginationHeaders","HubConnectionBuilder","BehaviorSubject","take","MessageService","constructor","http","busyService","baseUrl","apiUrl","hubUrl","messageThreadSouce","messageThread$","asObservable","createHubConnection","user","otherUsername","busy","hubConnection","withUrl","accessTokenFactory","token","withAutomaticReconnect","build","start","catch","error","console","log","finally","idle","on","messages","next","message","pipe","subscribe","group","connections","some","x","username","forEach","dateRead","Date","now","stopHubConnection","stop","getMessages","pageNumber","pageSize","container","params","append","getMessageThread","get","sendMessage","content","_this","_asyncToGenerator","invoke","recipientUsername","deleteMessage","id","delete","_","i0","ɵɵinject","i1","HttpClient","i2","BusyService","_2","factory","ɵfac","providedIn"],"sources":["C:\\Users\\BongumusaN\\TestingApp\\client\\src\\app\\_services\\message.service.ts"],"sourcesContent":["import { HttpClient } from '@angular/common/http';\r\nimport { Injectable } from '@angular/core';\r\nimport { environment } from 'src/environments/environment';\r\nimport { getPaginatedResult, getPaginationHeaders } from './paginationHelper';\r\nimport { Message } from '../_models/message';\r\nimport { HubConnection, HubConnectionBuilder } from '@microsoft/signalr';\r\nimport { User } from '../_models/user';\r\nimport { BehaviorSubject, take } from 'rxjs';\r\nimport { Group } from '../_models/group';\r\nimport { BusyService } from './busy.service';\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class MessageService {\r\n  baseUrl = environment.apiUrl;\r\n  hubUrl = environment.hubUrl;\r\n  private hubConnection?: HubConnection;\r\n  private messageThreadSouce = new BehaviorSubject<Message[]>([]);\r\n  messageThread$ = this.messageThreadSouce.asObservable();\r\n\r\n  constructor(private http: HttpClient, private busyService: BusyService) { }\r\n\r\n  createHubConnection(user: User, otherUsername: string) {\r\n    this.busyService.busy();\r\n    this.hubConnection = new HubConnectionBuilder()\r\n      .withUrl(this.hubUrl + 'message?user=' + otherUsername, {\r\n        accessTokenFactory: () => user.token\r\n      })\r\n      .withAutomaticReconnect()\r\n      .build();\r\n    this.hubConnection.start()\r\n      .catch(error => console.log(error))\r\n      .finally(() => this.busyService.idle());\r\n\r\n    this.hubConnection.on('ReceiveMessageThread', messages => {\r\n      this.messageThreadSouce.next(messages);\r\n    })\r\n\r\n    this.hubConnection.on('NewMessage', message => {\r\n      this.messageThread$.pipe(take(1)).subscribe({\r\n        next: messages => {\r\n          this.messageThreadSouce.next([...messages, message])\r\n        }\r\n      })\r\n    })\r\n\r\n    this.hubConnection.on('UpdatedGroup', (group: Group) => {\r\n      if (group.connections.some(x => x.username === otherUsername)) {\r\n        this.messageThread$.pipe(take(1)).subscribe({\r\n          next: messages => {\r\n            messages.forEach(message => {\r\n              if (!message.dateRead) {\r\n                message.dateRead = new Date(Date.now())\r\n              }\r\n            })\r\n            this.messageThreadSouce.next([...messages]);\r\n          }\r\n        })\r\n      }\r\n    })\r\n  }\r\n\r\n  stopHubConnection() {\r\n    if (this.hubConnection) {\r\n      this.messageThreadSouce.next([]);\r\n      this.hubConnection?.stop();\r\n    }\r\n  }\r\n\r\n  getMessages(pageNumber: number, pageSize: number, container: string) {\r\n    let params = getPaginationHeaders(pageNumber, pageSize);\r\n    params = params.append('Container', container);\r\n    return getPaginatedResult<Message[]>(this.baseUrl + 'messages', params, this.http);\r\n  }\r\n\r\n  getMessageThread(username: string) {\r\n    return this.http.get<Message[]>(this.baseUrl + 'messages/thread/' + username);\r\n  }\r\n\r\n  async sendMessage(username: string, content: string) {\r\n    return this.hubConnection?.invoke('SendMessage', { recipientUsername: username, content })\r\n      .catch(error => console.log(error));\r\n  }\r\n\r\n  deleteMessage(id: number) {\r\n    return this.http.delete(this.baseUrl + 'messages/' + id);\r\n  }\r\n}\r\n"],"mappings":"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"},"metadata":{},"sourceType":"module","externalDependencies":[]}